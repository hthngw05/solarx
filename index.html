<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SolarX Pro | Smart Monitoring</title>

  <style>
    :root {
      --bg: #050814;
      --panel: rgba(14, 22, 51, 0.8);
      --text: #e9eefc;
      --muted: rgba(233, 238, 252, 0.6);
      --stroke: rgba(255, 255, 255, 0.1);
      --shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
      /* Status Colors */
      --green: #33d17a;
      --amber: #ffb300;
      --red: #f66151;
      --blue: #3584e4;
    }

    * { box-sizing: border-box; transition: all 0.3s ease; }

    body {
      margin: 0;
      color: var(--text);
      background: radial-gradient(circle at 10% 10%, #101c44 0%, var(--bg) 60%) fixed;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      padding: 30px;
    }

    .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    h1 { margin: 0; font-weight: 800; letter-spacing: -1px; font-size: 32px; color: #fff; }

    .wrap { display: grid; grid-template-columns: 450px 1fr; gap: 25px; align-items: start; }

    .card {
      background: var(--panel);
      border: 1px solid var(--stroke);
      border-radius: 24px;
      box-shadow: var(--shadow);
      padding: 24px;
      backdrop-filter: blur(15px);
    }

    /* Status Glow Logic */
    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      border-radius: 100px;
      background: rgba(255,255,255,0.05);
      margin: 15px 0;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 13px;
      border: 1px solid var(--stroke);
    }

    /* KPI Display */
    .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
    .kpi-box { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 18px; border: 1px solid var(--stroke); }
    .label { color: var(--muted); font-size: 12px; font-weight: 600; text-transform: uppercase; }
    .big { font-size: 32px; font-weight: 800; margin-top: 5px; font-variant-numeric: tabular-nums; }

    /* Progress Bar for SR */
    .sr-container { margin: 20px 0; }
    .progress-bg { height: 10px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; margin-top: 10px; }
    #srBar { height: 100%; width: 0%; border-radius: 10px; box-shadow: 0 0 15px currentColor; }

    /* Table-like rows */
    .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--stroke); font-size: 14px; }
    .info-row:last-child { border: none; }

    .btn-group { display: flex; gap: 12px; margin-top: 25px; }
    button {
      flex: 1;
      padding: 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.08);
      color: white;
      font-weight: 700;
      cursor: pointer;
    }
    button:hover { background: rgba(255,255,255,0.15); transform: translateY(-2px); }
    button:active { transform: translateY(0); }
    .btn-primary { background: var(--blue); border: none; }

    .toast-area { margin-top: 15px; height: 20px; font-size: 13px; font-style: italic; color: var(--blue); }

    /* Right Side Analytics */
    iframe { width: 100%; height: 600px; border-radius: 20px; border: 1px solid var(--stroke); background: #000; }
  </style>
</head>

<body>

<div class="header-bar">
  <h1>SolarX <span style="color:var(--blue)">PRO</span></h1>
  <div id="ts" class="label" style="text-transform:none">Syncing...</div>
</div>

<div class="wrap">
  <div class="card">
    <div class="label">System Status</div>
    <div id="pill" class="status-pill">
      <span id="dot" style="width:12px; height:12px; border-radius:50%"></span>
      <span id="status">CONNECTING...</span>
    </div>

    <div class="sr-container">
      <div class="label">Panel Efficiency (Soiling Ratio)</div>
      <div id="sr" class="big">-</div>
      <div class="progress-bg"><div id="srBar"></div></div>
    </div>

    <div class="kpi-grid">
      <div class="kpi-box">
        <div class="label">Current Power</div>
        <div id="power" class="big">-</div>
      </div>
      <div class="kpi-box">
        <div class="label">Expected</div>
        <div id="ep" class="big" style="color:var(--muted)">-</div>
      </div>
    </div>

    <div class="card" style="background:rgba(0,0,0,0.1); padding:15px; margin-bottom:15px;">
      <div class="info-row"><span>Irradiance</span><span id="lux" class="v">-</span></div>
      <div class="info-row"><span>Voltage / Current</span><span><span id="voltage">-</span>V / <span id="current">-</span>A</span></div>
      <div class="info-row"><span>Clean Attempts</span><span id="attempts">-</span></div>
      <div class="info-row"><span>Last Action</span><span id="lastcmd" style="color:var(--blue)">-</span></div>
    </div>

    <div class="btn-group">
      <button class="btn-primary" onclick="forceClean()">Trigger Auto-Clean</button>
      <button onclick="manualDone()">Log Manual Repair</button>
    </div>
    <div id="toast" class="toast-area"></div>
  </div>

  <div class="card" style="padding:10px">
    <div style="padding:15px">
      <div class="label">Live Performance Analytics</div>
      <div style="font-size:12px; color:var(--muted)">Data Source: <span id="src" style="color:var(--green)">-</span></div>
    </div>
    <iframe id="qsFrame" title="SolarX Analytics"></iframe>
  </div>
</div>

<script>
const API_BASE = "https://qttukmuwnl.execute-api.ap-southeast-2.amazonaws.com/prod";
const DEVICE_ID = "SolarX_Device_01";
const EMBED_ENDPOINT = `${API_BASE}/embed`;

function fmt(n, dp=2){
  if(n === null || n === undefined) return "-";
  const x = Number(n);
  return Number.isNaN(x) ? "-" : x.toFixed(dp);
}

function updateUI(d) {
  const status = d.status || d.last_status;
  const sr = parseFloat(d.soiling_ratio) || 0;
  
  // Update Text
  document.getElementById("status").textContent = status;
  document.getElementById("sr").textContent = fmt(sr, 2);
  document.getElementById("power").textContent = fmt(d.power_w, 1) + "W";
  document.getElementById("ep").textContent = fmt(d.expected_power_w, 1) + "W";
  document.getElementById("lux").textContent = fmt(d.irradiance_lux, 0) + " lux";
  document.getElementById("voltage").textContent = fmt(d.voltage_v, 1);
  document.getElementById("current").textContent = fmt(d.current_a, 2);
  document.getElementById("attempts").textContent = d.clean_attempts || 0;
  document.getElementById("lastcmd").textContent = d.last_command_sent || "NONE";
  document.getElementById("ts").textContent = "Last Updated: " + new Date(d.timestamp).toLocaleTimeString();
  document.getElementById("src").textContent = d.status ? "AWS DYNAMODB (LIVE)" : "AWS STATE ENGINE";

  // Visual Logic: Status Pill & Glow
  const dot = document.getElementById("dot");
  const pill = document.getElementById("pill");
  const bar = document.getElementById("srBar");

  if(status === "NORMAL") {
    dot.style.background = "var(--green)";
    pill.style.boxShadow = "0 0 15px rgba(51, 209, 122, 0.3)";
    bar.style.backgroundColor = "var(--green)";
  } else if(status === "DIRTY") {
    dot.style.background = "var(--amber)";
    pill.style.boxShadow = "0 0 15px rgba(255, 179, 0, 0.3)";
    bar.style.backgroundColor = "var(--amber)";
  } else {
    dot.style.background = "var(--red)";
    bar.style.backgroundColor = "var(--red)";
  }

  // Update Progress Bar width
  bar.style.width = (sr * 100) + "%";
}

async function refresh(){
  try {
    const res = await fetch(`${API_BASE}/latest?device_id=${DEVICE_ID}`);
    const d = await res.json();
    updateUI(d);
  } catch (e) {
    console.error("Fetch error", e);
  }
}

async function loadEmbed(){
  try {
    const res = await fetch(EMBED_ENDPOINT);
    const data = await res.json();
    document.getElementById("qsFrame").src = data.embedUrl;
  } catch (e) {
    document.getElementById("toast").textContent = "QuickSight Sync Failed";
  }
}

async function post(path, payload){
  const toast = document.getElementById("toast");
  toast.textContent = "Processing request...";
  await fetch(`${API_BASE}${path}`, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(payload)
  });
  toast.textContent = "Command executed successfully.";
  setTimeout(() => toast.textContent = "", 3000);
}

function forceClean(){ post("/force-clean", { device_id: DEVICE_ID, duration_sec:20 }); }
function manualDone(){ post("/manual-done", { device_id: DEVICE_ID }); }

// Initial Load
refresh();
loadEmbed();

// Loops
setInterval(refresh, 5000); // 5 sec live refresh
setInterval(loadEmbed, 55 * 60 * 1000); // Refresh AWS Token every 55 mins
</script>
</body>
</html>
